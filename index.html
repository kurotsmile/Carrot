<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Carrot Store</title>
    <link rel="shortcut icon" href="images/favicon.ico" / type="images/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css?ver=1.2">
    <link rel="stylesheet" type="text/css" href="assets/css/style.css" />
    <link href="fontawesome6.4.0/css/fontawesome.css" rel="stylesheet">
    <link href="fontawesome6.4.0/css/brands.css" rel="stylesheet">
    <link href="fontawesome6.4.0/css/solid.css" rel="stylesheet">
</head>

<body>
    <header class="head">
        <div class="logo border-bottom">
            <img id="logo_carrot" class="w-100" src="images/logo.jpg" alt="Carrot Store" />
            <a class="navbar-toggler d-block d-lg-none" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
                aria-label="Toggle navigation">
                <i class="bi fa-solid fa-bars"></i>
            </a>
        </div>
        <div id="navbarNav" class="navcol pt-0 d-none d-lg-block">
            <ul>
                <li id="btn_home" class="border-bottom btn-menu"><i class="fa-solid fa-home fs-6 me-2"></i> <lang class="lang" key_lang="home">Home</lang></li>
                <li id="btn_all_app" class="border-bottom btn-menu"><i class="fa-solid fa-mobile bi fs-6 me-2"></i> <i
                        class="bi fs-6  bi-google-play"></i> <lang class="lang" key_lang="app">Applications</lang></li>
                <li id="btn_all_game" class="border-bottom btn-menu"><i class="fa-solid fa-gamepad bi me-2 fs-6"></i>
                    <lang class="lang" key_lang="game">Games</lang></li>
                <li id="btn_address_book" class="border-bottom btn-menu"><i
                        class="fa-solid fa-address-book fs-6 me-2"></i> <lang class="lang" key_lang="phone_book">Phone book</lang></li>
                <li id="btn_wallpapers" class="border-bottom btn-menu"><i class="fa-solid fa-image fs-6 me-2"></i>
                    <lang class="lang" key_lang="wallpaper">Wallpapers</lang></li>
                <li id="btn_all_icon" class="border-bottom btn-menu"><i class="fa-solid fa-face-smile fs-6 me-2"></i>
                    <lang class="lang" key_lang="icon">Icon</lang></li>
                <li id="btn_privacy_policy" class="border-bottom btn-menu"><i
                        class="fa-sharp fa-solid fa-building-shield fs-6 me-2"></i> <lang class="lang" key_lang="privacy_policy">Privacy Policy</lang></li>
                <li id="btn_about_us" class="border-bottom btn-menu"><i class="fa-solid fa-heart fs-6 me-2"></i> <lang class="lang" key_lang="about_us">About
                    Us</lang></li>
                <li id="btn_model_site" class="border-bottom btn-menu"><i class="fa-solid fa-window-maximize fs-6 me-2"></i> Development mode</li>

                <li class="btn-group dropup border-bottom dev btn-menu">
                    <div type="button" class="dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <i class="fa-solid fa-add fs-6 me-2"></i> Add Obj
                    </div>
                    <div class="dropdown-menu">
                        <div class="dropdown-item btn-menu" id="btn_add_app" role="button"><i class="fa-solid fa-add fs-6 me-2"></i> Add App</div>
                        <div class="dropdown-item btn-menu" id="btn_add_icon" role="button"><i class="fa-solid fa-add fs-6 me-2"></i> Add Icon</div>
                        <div class="dropdown-item btn-menu" id="btn_add_wallpaper" role="button"><i class="fa-solid fa-add fs-6 me-2"></i> Add Background</div>
                        <div class="dropdown-item btn-menu" id="btn_add_lang" role="button"><i class="fa-solid fa-add fs-6 me-2"></i> Add Lang</div>
                    </div>
                </li>

                <li class="btn-group dropup border-bottom dev btn-menu">
                    <div type="button" class="dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <i class="fa-solid fa-rotate fs-6 me-2"></i> Backup and Sync
                    </div>

                    <div class="dropdown-menu">
                        <div class="dropdown-item btn-menu" id="btn_download_json" role="button"><i class="fa-solid fa-download fs-6 me-2"></i> Export Collection json</div>
                        <div class="dropdown-item btn-menu" id="btn_import_json" role="button"><i class="fa-solid fa-file-import fs-6 me-2"></i> Import Collection json</div>
                        <div class="dropdown-item btn-menu" id="btn_download_json_doc" role="button"><i class="fa-solid fa-file-lines fs-6 me-2"></i> Export Doc json</div>
                        <div class="dropdown-item btn-menu" id="btn_import_json_doc" role="button"><i class="fa-solid fa-file-lines fs-6 me-2"></i> Import Doc json</div>
                    </div>
                </li>

                <li id="btn_ai_lover_all_chat" class="border-bottom btn-menu dev"><i class="fa-brands fa-rocketchat"></i> Chat Ai</li>
                <li id="btn_mode_host" class="border-bottom btn-menu dev"><i class="fa-solid fa-dev fs-6 me-2"></i> Localhost</li>
                <li id="btn_version_data" class="border-bottom btn-menu dev"><i class="fa-regular fa-code-compare"></i> Version</li>
                
                <li class="btn-group dropup border-bottom">
                    <div type="button" class="dropdown-toggle" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        <i class="fa-solid fa-globe fs-6 me-2"></i> <lang class="lang" key_lang="select_lang">Select Language</lang> <span class="fs-8 text-warning" id="key_lang">en</span>
                    </div>
                    <div class="dropdown-menu dropdown-multicol">
                        <div class="dropdown-row" id="list_lang_1" style="float: left;width: 40%;"></div>
                        <div class="dropdown-row" id="list_lang_2" style="float: left;width: 40%;"></div>
                    </div>
                </li>
            </ul>
        </div>
    </header>
    <div class="main-content">
        <div class="nav-bar sticky-top-xl bg-white shadow-sm w-100 p-3">
            <div class="row">
                <div class="col-md-5">
                    <div class="input-group mb-0">
                        <input id="box_input_search" type="text" class="form-control border-end-0 mb-0" placeholder="Search Apps" aria-label="Recipient's username" aria-describedby="basic-addon2">
                        <span class="input-group-text sit border-start-0" id="basic-addon2"><i class="fa-sharp fa-solid fa-magnifying-glass"></i></span>
                    </div>
                </div>
                <div class="col-md-3 text-end">&nbsp;</div>
                <div class="col-md-4 text-end">
                    <div class="dropdown pt-2">
                        <a id="btn_login" class="btn btn-small btn-light cpfs-8">
                            <i class="fa-solid fa-user"></i> <lang class="lang" key_lang="login">Login</lang>
                        </a>

                        <a id="btn_acc_info" class="btn btn-small btn-light cpfs-8 dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="true">
                            <img id="acc_info_avatar" style="width: 20px;height: 20px;" src="images/avatar_default.png"/> <span id="acc_info_name">User name</span>
                        </a>

                        <ul class="dropdown-menu" id="menu_account">
                            <li><a class="dropdown-item" href="#"><i class="fa-solid fa-circle-info"></i> <l class="lang" key_lang="acc_info">Edit Info</l></a></li>
                            <li><a id="btn_logout" class="dropdown-item" href="#" > <i class="fa-solid fa-right-from-bracket"></i> <l class="lang" key_lang="logout">Logout</l></a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div id="main_contain" class="section-container p-2 p-xl-4">
            <div class="row m-0">
                Have a nice day!
            </div>
        </div>
    </div>
    <script src="assets/js/jquery-3.2.1.min.js"></script>
    <script src="https://getbootstrap.com/docs/4.1/assets/js/vendor/popper.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/plugins/scroll-fixed/jquery-scrolltofixed-min.js"></script>
    <script src="assets/plugins/testimonial/js/owl.carousel.min.js"></script>
    <script src="assets/js/script.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-message-box@3.2.2/dist/messagebox.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-message-box@3.2.2/dist/messagebox.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.css" />
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, query, where, getDocs, deleteDoc, connectFirestoreEmulator } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        
        var mode_site = "nomal";
        var is_dev = false;
        var count_dev = 0;
        var is_localhost = false;

        var link_store = null;
        var list_lang = null;
        var list_app = null;
        var lang_web=Object();
        var obj_login=null;
        var db;
        var id_page;

        var carrot=new Carrot_Site();

        carrot.load_lang();

        if (localStorage.getItem("is_localhost") == null) {
            is_localhost = false;
        } else {
            if (localStorage.getItem("is_localhost") == "false")
                is_localhost = false;
            else
                is_localhost = true;
        }

        if(localStorage.getItem("list_app")!=null) list_app=JSON.parse(localStorage.getItem("list_app"));
        if(localStorage.getItem("link_store")!=null) link_store=JSON.parse(localStorage.getItem("link_store"));
        if(localStorage.getItem("lang_web")!=null) lang_web=JSON.parse(localStorage.getItem("lang_web"));

        if(localStorage.getItem("obj_login")!=null) obj_login=JSON.parse(localStorage.getItem("obj_login"));
        if(localStorage.getItem("mode_site") != null) mode_site = localStorage.getItem("mode_site");
        if(localStorage.getItem("is_dev") != null) is_dev = localStorage.getItem("is_dev");

        const firebaseConfig_main = {
            apiKey: "AIzaSyDzsx1KYLZL5COz1NaTD8cOz8GYalX2Dxc",
            authDomain: "carrotstore.firebaseapp.com",
            projectId: "carrotstore",
            storageBucket: "carrotstore.appspot.com",
            messagingSenderId: "745653792874",
            appId: "1:745653792874:web:55d78113cd3dea7c28da13",
            measurementId: "G-KXDDJ42JFN"
        };

        const app = initializeApp(firebaseConfig_main);
        db = getFirestore(app);

        if (is_localhost) {
            db = getFirestore();
            connectFirestoreEmulator(db, '192.168.1.59', 8080);
        }

        var ai_lover=new Ai_Lover(db);

        function show_home(){
            console.log('show_home');
            carrot.show_list_app(list_app, link_store);
            check_btn_app_dev();
            check_mode_site();
        }

        function show_all_app(){
            console.log('show_all_app');
            var list_app_mobile=Array();
            $(list_app).each(function(index,emp){
                if(emp.type == "app") list_app_mobile.push(emp);
            });
            carrot.show_list_app(list_app_mobile, link_store);
            check_btn_app_dev();
            check_mode_site();
        }

        function show_all_game(){
            console.log('show_all_game');
            var list_game=Array();
            $(list_app).each(function(index,emp){
                if(emp.type == "game") list_game.push(emp);
            });
            carrot.show_list_app(list_game, link_store);
            check_btn_app_dev();
            check_mode_site();
        }

        $('#list_lang_1,#list_lang_2').on('click', '.item_lang', async function () {
            var key_lang = $(this).attr("key");
            if (key_lang != carrot.lang) {
                $(".item_lang").removeClass("active");
                $(this).addClass("active");
                carrot.change_lang(key_lang);
                get_all_data_lang_web();
                check_show_by_id_page();
            };
        });

        function check_mode_site() {
            if (mode_site == "nomal")
                $(".dev").each(function () { $(this).hide(100); });
            else
                $(".dev").each(function () { $(this).show(100); });
        }

        function act_mode_dev() {
            count_dev++;
            if (count_dev >= 3) {
                is_dev = true;
                localStorage.setItem("is_dev", is_dev);
                $("#btn_model_site").show();
                count_dev = 0;
                $.MessageBox("Active Model Dev!");
            }
        }

        async function show_list_by_collection(collection_name) {
            var q = query(collection(db, collection_name));
            var querySnapshot = await getDocs(q);
            var t = "<table>";
            querySnapshot.forEach(doc => {
                var data_doc = doc.data();
                t += "<tr>";
                $.each(data_doc, function (k, v) {
                    t += "<td>" + k + "</td><td>" + v + "</td>";
                });
                t += "</tr>";
            });
            t += "</table>";
            $("#all_app").html(t);
        }

        $("#logo_carrot").on("contextmenu", function () { act_mode_dev(); return false; });
        $("#btn_download_json").click(function () {download_json();});

        $(".btn-menu").click(async function () {
            $(".btn-menu").removeClass("active");
            $(".btn-menu i").removeClass("fa-bounce");
            $(this).addClass("active");
            $(this).find("i").addClass("fa-bounce");
            var id_fun = $(this).attr("id");

            if (id_fun == "btn_address_book") {
                var q = query(collection(db, "user-"+carrot.lang), where("status_share", "==", "0"));
                var querySnapshot = await getDocs(q);
                show_list_contact(querySnapshot);
                carrot.change_title_page("Address Book", "?p=address_book");
                id_page = "address_book";
            }

            if (id_fun == "btn_all_icon") show_all_icon();
            if (id_fun == "btn_wallpapers") show_all_wallpaper();

            if (id_fun == "btn_home"||id_fun=='logo_carrot') { 
                show_home();
                carrot.change_title_page("Carrot store", "/");
                id_page = "home";
            };

            if (id_fun == "btn_all_app") { 
                show_all_app();
                carrot.change_title_page("Apps", "?p=all_app");
                id_page = "app";
            };

            if (id_fun == "btn_all_game") { 
                show_all_game();
                carrot.change_title_page("Games", "?p=game");
                id_page = "game";
            };

            if (id_fun == "btn_about_us") {
                $("#main_contain").load("about_us/" + carrot.lang+".html?ver="+carrot.version["page"]);
                carrot.change_title_page("About Us", "?p=about_us");
                id_page = "about_us";
            };
            if (id_fun == "btn_privacy_policy") {
                $("#main_contain").load("privacy_policy/" + carrot.lang+".html?ver="+carrot.version["page"]);
                carrot.change_title_page("Privacy Policy", "?p=privacy_policy");
                id_page = "privacy_policy";
            };
            if (id_fun == "btn_mode_host") {
                if (is_localhost)
                    localStorage.setItem("is_localhost", "false");
                else
                    localStorage.setItem("is_localhost", "true");

                $.MessageBox("Thay đổi kế độ kết nối cơ sở dữ liệu thành công! Load lại trang để làm mới các chức năng!");
            }

            if (id_fun == "btn_model_site"){
                if (mode_site == "nomal")
                    mode_site = "dev";
                else
                    mode_site = "nomal";
                localStorage.setItem("mode_site", mode_site);
                check_mode_site();
            }

            if(id_fun=="btn_add_app") carrot.show_box_add_or_edit_app(link_store,null,act_done_add_or_edit);
            if(id_fun=='btn_add_icon') show_box_add_or_edit_icon(null,act_done_add_or_edit);
            if(id_fun=='btn_add_wallpaper') show_box_add_or_edit_wallpaper(null,act_done_add_or_edit);
            if(id_fun=='btn_add_lang') show_box_add_or_edit_lang(null,act_done_add_or_edit);

            if(id_fun=='btn_version_data') carrot.show_edit_version_data_version(act_done_edit_version_data_version);
            if(id_fun=='btn_ai_lover_all_chat') show_all_chat_ai_lover();
            if(id_fun=='btn_download_json_doc') download_json_doc();
            if(id_fun=='btn_import_json_doc') act_show_import_json_box(null);
            check_mode_site();
        });

        async function show_all_chat_ai_lover(){
            var querySnapshot = await getDocs(query(collection(db, "chat-vi"),where("status","==","pending")));
                ai_lover.show_all_chat(querySnapshot);
                $(".ai_lover_del_chat").each(function(index,emp){
                    $(emp).click(function(){
                        var id_doc=$(emp).attr("id_doc");
                        $.MessageBox({
                            buttonDone  : "Yes",
                            buttonFail  : "No",
                            message     : "Bạn có chắc chắng là xóa Trò chuyện "+id_doc+" này không?"
                        }).done(function(){
                            if(mode_site == "dev"){
                                act_del_obj("chat-"+carrot.lang,id_doc);
                            $(emp).parent().parent().remove();
                            }
                        });
                    });
                });

                $(".ai_lover_edit_chat").each(function(index,emp){
                    $(emp).click(async function(){
                        var id_doc=$(emp).attr("id_doc");
                        const chatRef = doc(db, "chat-"+carrot.lang, id_doc);
                        const chatSnap = await getDoc(chatRef);
                        if (chatSnap.exists()) {
                            var data_obj = chatSnap.data();
                            data_obj["id"]=chatSnap.id;
                            customer_field_for_db(data_obj,"chat-"+carrot.lang,'id','show_all_chat_ai_lover','Edit Obj Success');
                            ai_lover.show_edit_object(data_obj,act_done_add_or_edit);
                        } else {
                            $.MessageBox("Câu trò chuyện không còn tồn tại!");
                        }
                    });
                });

                let table = new DataTable('#table_all_chat', {responsive: true});
        }


        function act_show_import_json_box(data_show){
            if(data_show==null){
                data_show=new Object();
                data_show["collection"]="";
                data_show["document"]="";
            }
            $.MessageBox({
                input    : {db_collection:{'label': "Collection","defaultValue":data_show["collection"]},db_document:{'label': "Document ID","defaultValue":data_show["document"]},data:{'type': 'textarea','label': "Nhập kiểu dữ liệu văn bảng dạng json:"}},
                message  : "Import JSON document text"
            }).done(function(data, button){
                var s_collection=data.db_collection;
                var s_document=data.db_document;
                var data_import=JSON.parse(data.data);
                delete(data.db_collection);
                delete(data.db_document);
                delete(data.data);
                setDoc(doc(collection(db,s_collection),s_document),data_import);
                $.MessageBox("Import Data Json Success!!!");
            });
        }

        function act_done_add_or_edit(data){
            console.log(data);
            var act_msg_success=data.act_msg_success;
            var db_collection=data.db_collection;
            var db_doc=data.db_doc;
            var act_name_before=data.act_name_before;

            delete(data.act_msg_success);
            delete(data.db_collection);
            delete(data.db_doc);
            delete(data.act_name_before);
            setDoc(doc(collection(db,db_collection),data[db_doc]), data);
            $.MessageBox(act_msg_success);
            if(act_name_before!=null&&act_name_before!='') eval(act_name_before + "()");
        }

        function act_done_edit_version_data_version(data){
            setDoc(doc(collection(db, "setting_web"),"version"), data);
            $.MessageBox("Change version data site success!");
        }
        
        async function show_all_icon(){
            var q = query(collection(db, "icon"));
            var querySnapshot = await getDocs(q);
            show_list_icon(querySnapshot);
            carrot.change_title_page("Icon", "?p=icon");
            id_page = "icon";
        }

        async function show_all_wallpaper(){
            var q = query(collection(db, "background"));
            var querySnapshot = await getDocs(q);
            show_list_background(querySnapshot);
            carrot.change_title_page("Wallpapers", "?p=wallpapers");
            id_page = "wallpapers";
        }

        $("#btn_import_json").click(function () {
            var url_json = prompt("Enter url json", "Enter url");
            if (url_json != null) {
                $.ajax(url_json, {
                    success: function (data) {
                        var name_collection = data.collection;
                        var all_item = data.all_item;
                        var cr_data = collection(db, name_collection);
                        $.each(all_item, function (index, d) {
                            var doc_id = d["id_import"];
                            delete d["id_import"];
                            setDoc(doc(cr_data, doc_id), d);
                        });
                        $.MessageBox("Import Success!");
                    }
                });
            };
        });

        $("#btn_login").click(function () {
            $.MessageBox({
                message: "<b><i class='fa-solid fa-key'></i> "+l('login')+"</b>",
                input: {
                    usernames: {type: "text",label: l("phone"),title: "Enter Your Phone"},
                    password: {type: "password",label:l("password"),title: "Type password here"},
                    dummy_caption: {type: "caption",message: l("login_tip")}
                },
                top: "auto",
                buttonFail:l("cancel"),
                buttonDone  : {login:{text:l('login'),keyCode: 12},register:{text:l("register"),keyCode: 13}},
            }).done(function(data,button) {
                var username=data.usernames;
                var password=data.password;
                console.log(button);
                if(button=='login') check_user_login(username,password);
                if(button=='register') $.MessageBox("Registration Success");
            });
        });

        $("#btn_logout").click(function(){
            obj_login=null;
            localStorage.removeItem("obj_login");
            show_info_user_login_in_header(obj_login);
        });

        async function check_user_login(username,password){
            var q = query(collection(db, "user-"+carrot.lang), where("phone", "==", username),where("password", "==", password));
            var querySnapshot = await getDocs(q);
            if(querySnapshot.docs.length>0){
                querySnapshot.forEach((doc) => {
                    obj_login=doc.data();
                    localStorage.setItem("obj_login",JSON.stringify(obj_login));
                    show_info_user_login_in_header(obj_login);
                });
            }else{
                $.MessageBox("Đăng nhập thất bại!");
            }
        }

        async function act_del_app(id_app){
            await deleteDoc(doc(db, "app", id_app));
            $.MessageBox("Delete App ('" + id_app + "') Success!");
        }

        async function act_del_obj(db_collection,db_doc_id){
            await deleteDoc(doc(db, db_collection, db_doc_id));
            $.MessageBox("Delete object ('" + db_doc_id + "') Success!");
        }

        async function download_json() {
            var name_collection = prompt("Enter collection json", "Enter name collection");
            if (name_collection == "") return;
            var data_json = Object();
            data_json["all_item"] = Array();
            data_json["collection"] = name_collection;
            var q = query(collection(db, name_collection));
            var querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                var data_app = doc.data();
                data_app["id_import"] = doc.id;
                data_json.all_item.push(data_app);
            });

            var fileContents = JSON.stringify(data_json, null, 2);
            var fileName = name_collection + ".json";

            var pp = document.createElement('a');
            pp.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(fileContents));
            pp.setAttribute('download', fileName);
            pp.click();
        }

        async function act_download_json_by_collection_and_doc(name_collection, name_document) {
            var data_json = Object();
            const verRef = doc(db, name_collection,name_document);
            const verSnap = await getDoc(verRef);
            if (verSnap.exists()) {
                data_json=verSnap.data();

                var fileContents = JSON.stringify(data_json, null, 2);
                var fileName = name_collection+"-"+name_document + ".json";

                var pp = document.createElement('a');
                pp.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(fileContents));
                pp.setAttribute('download', fileName);
                pp.click();
            }
        }

        function download_json_doc() {
            var name_collection = prompt("Enter collection", "Enter name collection");
            if(name_collection=="") return;
            var name_document = prompt("Enter document", "Enter document in collection");
            if (name_document== "") return;
            act_download_json_by_collection_and_doc(name_collection,name_document);
        }

        async function get_all_data_app() {
            console.log("get_all_data_app");
            list_app = Array();
            var q = query(collection(db, "app"));
            var querySnapshot_app = await getDocs(q);
            querySnapshot_app.forEach((doc) => {
                var data_app=doc.data();
                data_app["id"]=doc.id;
                carrot.obj_app[doc.id]=JSON.stringify(data_app);
                list_app.push(data_app);
            });
            carrot.save_obj_app();
            localStorage.setItem("list_app", JSON.stringify(list_app));
            show_home();
        };

        async function get_all_data_link_store() {
            console.log("get_all_data_link_store");
            link_store = Array();
            var q = query(collection(db, "link_store"));
            var querySnapshot_link_store = await getDocs(q);
            querySnapshot_link_store.forEach((doc) => {
                link_store.push(doc.data());
            });
            localStorage.setItem("link_store", JSON.stringify(link_store));
        };

        async function get_all_data_lang() {
            var cr_lang = collection(db, "lang");
            var q = query(cr_lang);
            var querySnapshot_lang = await getDocs(q);
            carrot.list_lang=Array();
            querySnapshot_lang.forEach((doc) => {
                var lang_data = doc.data();
                lang_data["id"]=doc.id;
                carrot.list_lang.push(lang_data);
            });
            carrot.save_list_lang();
        };

        async function get_all_data_lang_web(){
            console.log("get_all_data_lang_web");
            const docRef = doc(db, "lang_web",carrot.lang);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                lang_web=docSnap.data();
                localStorage.setItem("lang_web",JSON.stringify(lang_web));
                load_data_lang_web();
            }else{
                load_data_lang_web();
            }
        }

        function load_data_lang_web() {
            $(".lang").each(function(index,emp){
                    var key_lang=$(emp).attr("key_lang");
                    if(lang_web[key_lang]!=null){
                        $(emp).html(lang_web[key_lang].trim());
                    }
            });
        }

        function check_show_by_id_page() {
            id_page = get_param_url("p");
            if(id_page == "privacy_policy") $("#btn_privacy_policy").click();
            else if(id_page == "about_us") $("#btn_about_us").click();
            else if(id_page == "address_book") $("#btn_address_book").click();
            else if(id_page=="wallpapers") show_all_wallpaper();
            else if(id_page=="icon") show_all_icon();
            else show_home();
        }

        function check_btn_app_dev() {
            $(".app_icon").click(async function(){
                var id_box_app = $(this).attr("app_id");
                if(carrot.obj_app[id_box_app]!=null&&carrot.obj_app[id_box_app]!=""){
                    const appRef = doc(db, "app", id_box_app);
                    const appSnap = await getDoc(appRef);
                    if (appSnap.exists()) {
                        var data_app = appSnap.data();
                        data_app["id"]=appSnap.id;
                        carrot.show_app_info(data_app,link_store,list_app);
                        check_mode_site();
                        check_btn_app_dev();
                        load_data_lang_web();
                    } else {
                        $.MessageBox("Ứng dụng không tồn tại!");
                    }
                }else{
                    var data_app=JSON.parse(carrot.obj_app[id_box_app]);
                    carrot.show_app_info(data_app,link_store,list_app);
                    check_mode_site();
                    check_btn_app_dev();
                    load_data_lang_web();
                }
            });

            $(".btn_app_edit").click(async function () {
                var id_box_app = $(this).attr("app_id");
                var q = query(collection(db, "app"), where("name_en", "==", id_box_app));
                var querySnapshot_edit_app = await getDocs(q);
                querySnapshot_edit_app.forEach((doc) => {
                    var data_app=doc.data();
                    if(mode_site == "dev") carrot.show_box_add_or_edit_app(link_store,data_app,act_done_add_or_edit);
                });
            });

            $(".btn_app_del").click(async function () {
                var id_box_app = $(this).attr("app_id");
                $.MessageBox({
                    buttonDone  : "Yes",
                    buttonFail  : "No",
                    message     : "Bạn có chắc chắng là xóa ứng dụng "+id_box_app+" này không?"
                }).done(function(){
                    if(mode_site == "dev") act_del_app(id_box_app);
                });
            });

            $(".btn_app_export").click(function(){
                var app_id=$(this).attr("app_id");
                var data_collection=$(this).attr("data-collection");
                act_download_json_by_collection_and_doc(data_collection,app_id);
            });

            $(".btn_app_import").click(function(){
                var app_id=$(this).attr("app_id");
                var data_collection=$(this).attr("data-collection");
                var obj_data=new Object();
                obj_data["collection"]=data_collection;
                obj_data["document"]=app_id;
                act_show_import_json_box(obj_data);
            });
        }

        function l(key){if (lang_web[key] != null) return lang_web[key].trim();else return key;}
            
        async function check_version_data(){
            var obj_version_cur =carrot.version;
            const verRef = doc(db, "setting_web","version");
            const verSnap = await getDoc(verRef);
            if (verSnap.exists()) {
                var ver_data_new=verSnap.data();
                if(ver_data_new.link_store!=obj_version_cur["link_store"]) get_all_data_link_store();
                if(ver_data_new.lang_web!=obj_version_cur["lang_web"]) get_all_data_lang_web();
                if(ver_data_new.app!=obj_version_cur["app"]) get_all_data_app();
                if(ver_data_new.js!=obj_version_cur["js"]){
                    var ver_data_js=ver_data_new.js;
                    $(".emp_js").each(function(){
                        var src_url=$(this).attr("src");
                        $(this).attr("src",src_url+"?ver="+ver_data_js);
                    });
                }
                if(ver_data_new.lang!=obj_version_cur["lang"]) get_all_data_lang();
                carrot.set_version_data_cur(ver_data_new);
                check_show_by_id_page();
            }else{
                carrot.show_list_lang_in_menu();
                check_show_by_id_page();
            }
        }

        $(document).ready(function () {
            var lang_page=get_param_url("lang");
            if(lang_page!=null){
                if(lang_page!=carrot.lang){
                    carrot.lang_url=lang_page;
                    carrot.change_lang(lang_page);
                    get_all_data_lang_web();
                }
            }
            check_version_data();;
            load_data_lang_web();
            show_info_user_login_in_header(obj_login);
            $("#key_lang").html(carrot.lang);
            if (is_dev) {
                $("#btn_model_site").show();
            } else {
                $("#btn_model_site").hide();
                mode_site == "nomal";
            }

            if (is_localhost) {
                $("#btn_mode_host").html('<i class="fa-brands fa-dev fs-6 me-2"></i> Localhost');
            } else {
                $("#btn_mode_host").html('<i class="fa-sharp fa-solid fa-database fs-6 me-2"></i> Googlehost');
            }
        });
    </script>
    <script src="js/main.js" type="text/javascript" class="emp_js" data-ver="1.6"></script>
    <script src="js/ai_lover.js" type="text/javascript" class="emp_js" data-ver="1.6"></script>
    <script src="js/carrot_site.js" type="text/javascript" class="emp_js" data-ver="1.6"></script>
</body>
</html>