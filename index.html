<html>
<head>
    <meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>Carrot</title>

	<meta name="author" content="Tran Thien Thanh"/>
	<meta name="description" content="Carrot App Store"/>
	<meta name="viewport" content="width=device-width"/>

	<link rel="shortcut icon" href="images/favicon.ico"/>
    <link href="css/style_basic.css" rel="stylesheet"/>
    <link href='http://fonts.googleapis.com/css?family=Lato&subset=latin,latin-ext' rel='stylesheet' type='text/css'>

	<script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/edb66aed37.js" crossorigin="anonymous"></script>

    <script type="module">
        import {initializeApp} from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import {getFirestore, collection, addDoc,setDoc,doc,getDoc,query, where,getDocs,deleteDoc} from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        var lang="";
        var mode_site="nomal";

        var data_lang=Array();

        if(localStorage.getItem("lang")==null){
            lang="en";
            localStorage.setItem("lang",lang);
        }else{
            lang=localStorage.getItem("lang");
        }

        const firebaseConfig = {
            apiKey: "AIzaSyDzsx1KYLZL5COz1NaTD8cOz8GYalX2Dxc",
            authDomain: "carrotstore.firebaseapp.com",
            projectId: "carrotstore",
            storageBucket: "carrotstore.appspot.com",
            messagingSenderId: "745653792874",
            appId: "1:745653792874:web:55d78113cd3dea7c28da13",
            measurementId: "G-KXDDJ42JFN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const cr_app = collection(db, "app");
        const cr_lang= collection(db, "lang");
        const cr_link_store= collection(db, "link_store");

        function objectifyForm(formArray) {
            var returnArray = {};
            for (var i = 0; i < formArray.length; i++){
                returnArray[formArray[i]['name']] = formArray[i]['value'];
            }
            return returnArray;
        }

        function add_app(data_app){
            setDoc(doc(cr_app, data_app.name_en), data_app);
            get_all_app();
        }

        function add_lang(data_lang){
            setDoc(doc(cr_lang, data_lang.key), data_lang);
            close_all_box();
        }

        function add_link_store(data_links_store){
            setDoc(doc(cr_link_store, data_links_store.key), data_links_store);
            close_all_box();
        }

        async function get_all_app(){
            $("#all_app").show();
            $("#all_app").html("");
            var q = query(collection(db, "app"));
            var querySnapshot =await getDocs(q);
            querySnapshot.forEach((doc) => {
                var data_app=doc.data();
                var key_name="name_"+lang;
                var htm_item_app="<div class='box_app' id=\""+doc.id+"\">";
                    htm_item_app+="<img src=\""+data_app.icon+"\"/><br/>";
                    htm_item_app+="<b>"+read_prop(data_app,key_name)+"</b>";
                    htm_item_app+="<div>"+data_app.name_en+"</div>";
                    htm_item_app+="<div class='btn dev btn_app_edit' app_id='"+doc.id+"'><i class=\"fa-solid fa-pen-to-square\"></i> Edit</div>";
                    htm_item_app+="<div class='btn dev btn_app_del' app_id='"+doc.id+"'><i class=\"fa-solid fa-trash\"></i> Delete</div>";
                    htm_item_app+="<div>";
                $("#all_app").append(htm_item_app);
            });
        }

        function read_prop(obj, prop) {
            return obj[prop];
        }

        async function get_all_field_name_app_lang(){
            var q = query(collection(db, "lang"));
            var querySnapshot =await getDocs(q);
            querySnapshot.forEach((doc) => {
                var field_data=doc.data();
                $("#all-field").append(add_field("name_"+field_data.key,"Name("+field_data.name+")"));
            });
        }

        async function get_all_field_link_store(){
            var q = query(cr_link_store);
            var querySnapshot =await getDocs(q);
            querySnapshot.forEach((doc) => {
                var field_data=doc.data();
                $("#all-field").append(add_field(field_data.key,"Link Store ("+field_data.name+")"));
            });
        }

        $("#btn_list_lang").click(async function(){
            $("#box_lang_bk").show();
            $("#box_lang").html("");
            if(data_lang.length==0){
                var q = query(collection(db, "lang"));
                var querySnapshot =await getDocs(q);
                querySnapshot.forEach((doc) => {data_lang.push(doc.data());});
                show_menu_lang(data_lang);
            }else{
                show_menu_lang(data_lang);
            }
        });

        function show_menu_lang(data_lang){
            $.each(data_lang, function(idx, obj){ 
                var htm_item_app="<div class='item_lang' key='"+obj.key+"'>";
                $.each(obj, function(key, value){
                    htm_item_app+="<b>"+key+"</b>:"+value;
                });
                htm_item_app+="<div>";
                $("#box_lang").append(htm_item_app);
            });
        }

        $('#box_lang').on('click', '.item_lang', function() {
            var key_lang=$(this).attr("key");
            if(key_lang!=lang){
                lang=key_lang;
                localStorage.setItem("lang", lang);
                $("#key_lang").html(lang);
            }
            $("#box_lang_bk").hide();
            get_all_app();
        });

        $("#all_app").each(function(){
            $(this).each(function(){
               $(this).on('click', '.btn_app_edit',async function() {
                    var id_box_app=$(this).attr("app_id");
                    var q = query(collection(db, "app"), where("name_en", "==", id_box_app));
                    var querySnapshot =await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        var lang_data=doc.data();
                        $("#all_app").hide();
                        $("#all-field").html("");
                        $("#box_add_app").show(function(){
                            $.each(lang_data, function(key,val) {
                                $("#all-field").append(add_field(key,key,val));
                            });
                            $("#box_app_info").hide();
                            return;
                        });
                    });
                    return;
               });
            });
        }); 

        $("#all_app").each(function(){
            $(this).each(function(){
               $(this).on('click', '.btn_app_del',async function() {
                    var id_box_app=$(this).attr("app_id");
                    await deleteDoc(doc(db, "app", id_box_app));
                    get_all_app();
                    return;
               });
            });
        });

        $("#btn_model_site").click(function(){
            if(mode_site=="nomal")
                mode_site="dev";
            else
                mode_site="nomal";
            
            if(mode_site=="dev")
                $(".dev").each(function(){$(this).hide(100);});
            else
                $(".dev").each(function(){$(this).show(100);});
        });

        function show_box_add(func){
            $("#box_add_app").show();
            $("#all-field").html("");

            if(func=="add_app"){
                $("#box_add_icon").attr("class","fa-solid fa-mobile");
                $("#all-field").append(add_field("icon","Icon App"));
                get_all_field_name_app_lang();
                get_all_field_link_store();
            }

            if(func=="add_lang"){
                $("#box_add_icon").attr("class","fa-solid fa-globe");
                $("#all-field").append(add_field("key","Key lang"));
                $("#all-field").append(add_field("name","Name Lang"));
            }

            if(func=="add_link_store"){
                $("#box_add_icon").attr("class","fa-solid fa-store");
                $("#all-field").append(add_field("key","Key id Store"));
                $("#all-field").append(add_field("name","Name Store"));
                $("#all-field").append(add_field("icon","Icon Font"));
                $("#all-field").append(add_field("img","Iamge Store"));
            }
            
            var frm_box=$("#frm_add_app");
            $(frm_box).attr("type",func);
        }


        function done_add_box(){
            var data_frm=$('#frm_add_app').serializeArray();
            var frm_box=$("#frm_add_app");
            var func=$(frm_box).attr("type");
            var data_obj=objectifyForm(data_frm);

            if(func=="add_app") add_app(data_obj);
            if(func=="add_lang") add_lang(data_obj);
            if(func=="add_link_store") add_link_store(data_obj);

            $('#frm_add_app').each(function(){this.reset();});
            alert("Add Success "+lang+" func:"+func);
        }

        $("#btn_show_add_app").click(function(){show_box_add('add_app')});
        $("#btn_show_add_lang").click(function(){show_box_add('add_lang')});
        $("#btn_show_add_link_store").click(function(){show_box_add('add_link_store')});

        $("#btn_done_add_box").click(done_add_box);

        $(document).ready(function(){
            get_all_app();
            $("#key_lang").html(lang);
        });

        export{done_add_box};
    </script>
    <script src="js/main.js" type="text/javascript"></script>
</head>
<body>
    <div id="header">
        <img src="images/72.png">
        <div id="menu_head_right">

            <div id="btn_list_lang" class="btn">
                <i class="fa-solid fa-globe"></i><br> Select Lang<br>
                <div id="key_lang">En</div>
            </div>

            <div id="btn_model_site" class="btn">
                <i class="fa-solid fa-window-maximize fa-bounce"></i><br>Development mode
            </div>
        </div>
    </div>
    <div id="menu_dev" class="dev">
        <div id="btn_show_add_app" class="btn"><i class="fa-solid fa-mobile"></i> Add App</div>
        <div id="btn_show_add_lang" " class="btn"><i class="fa-solid fa-globe"></i> Add Lang</div>
        <div id="btn_show_add_link_store" class="btn"><i class="fa-solid fa-store"></i> Add Link Store</div>
    </div>

    <div id="box_add_app" class="box_add">
        <form class="frm" id="frm_add_app" method="post" type="add_app">
            <div class="frm-body">
                <div class="frm-line">
                    <i id="box_add_icon" class="fa-solid fa-mobile"></i> Add App
                </div>
                <div class="frm-all-item" id="all-field"></div>
                <div class="frm-line">
                    <div class="btn" id="btn_done_add_box"><i class="fa-solid fa-circle-check"></i> Done</div>
                    <div class="btn" onclick="close_all_box()"><i class="fa-solid fa-rectangle-xmark"></i> Cancel</div>
                </div>
            </div>
        </form>
    </div>

    <div id="box_lang_bk"><div id="box_lang"></div></div>
    <div id="box_app_info"></div>
    <div id="all_app"></div>
    <div id="box_msg">
        <div id="box_msg_border">
            <div id="box_msg_title">Title</div>
            <div id="box_msg_body">Boyd</div>
        </div>
    </div>
    
</body>
</html>