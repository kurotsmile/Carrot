<html>
<head>
    <meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>Carrot</title>

	<meta name="author" content="Tran Thien Thanh"/>
	<meta name="description" content="Carrot App Store"/>
	<meta name="viewport" content="width=device-width"/>
    <meta name="theme-color" content="#525252"/>

	<link rel="shortcut icon" href="images/favicon.ico"/>
    <link href="css/style_basic.css" rel="stylesheet"/>

	<script src="https://code.jquery.com/jquery-3.7.0.min.js" integrity="sha256-2Pmvv0kuTBOenSvLm6bvfBSSHrUJ+3A7x6P5Ebd07/g=" crossorigin="anonymous"></script>
    <link href="fontawesome6.4.0/css/fontawesome.css" rel="stylesheet">
    <link href="fontawesome6.4.0/css/brands.css" rel="stylesheet">
    <link href="fontawesome6.4.0/css/solid.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">

    <script type="module">
        import {initializeApp} from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import {getFirestore, collection, addDoc,setDoc,doc,getDoc,query, where,getDocs,deleteDoc,connectFirestoreEmulator} from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";
        var lang="";
        var mode_site="nomal";
        var is_dev=false;
        var count_dev=0;
        var is_localhost=false;

        var querySnapshot_link_store;
        var querySnapshot_lang;
        var data_edit_app;
        var list_store=null;
        var list_lang=null;
        var db;

        if(localStorage.getItem("lang")==null){
            lang="en";
            localStorage.setItem("lang",lang);
        }else{
            lang=localStorage.getItem("lang");
        }

        if(localStorage.getItem("is_localhost")==null){
            is_localhost=false;
        }else{
            if(localStorage.getItem("is_localhost")=="false")
                is_localhost=false;
            else
                is_localhost=true;
        }

        if(localStorage.getItem("mode_site")!=null) mode_site=localStorage.getItem("mode_site");
        if(localStorage.getItem("is_dev")!=null) is_dev=localStorage.getItem("is_dev");

        const firebaseConfig_main = {
            apiKey: "AIzaSyDzsx1KYLZL5COz1NaTD8cOz8GYalX2Dxc",
            authDomain: "carrotstore.firebaseapp.com",
            projectId: "carrotstore",
            storageBucket: "carrotstore.appspot.com",
            messagingSenderId: "745653792874",
            appId: "1:745653792874:web:55d78113cd3dea7c28da13",
            measurementId: "G-KXDDJ42JFN"
        };

        const app = initializeApp(firebaseConfig_main);
        db = getFirestore(app);

        if(is_localhost){
            db = getFirestore();
            connectFirestoreEmulator(db, 'localhost', 8082);
        }

        const cr_app = collection(db, "app");
        const cr_lang= collection(db, "lang");
        const cr_link_store= collection(db, "link_store");

        function add_app(data_app){
            setDoc(doc(cr_app, data_app.name_en), data_app);
            get_all_app();
        }

        function add_lang(data_lang){
            setDoc(doc(cr_lang, data_lang.key), data_lang);
            close_all_box();
        }

        function add_link_store(data_links_store){
            setDoc(doc(cr_link_store, data_links_store.key), data_links_store);
            close_all_box();
        }

        async function get_all_app(type=""){
            change_title_page("Carrot - All App","?p=all_app");
            $("#all_app").show();
            $("#all_app").html("");
            var q;
            if(type==""){
                $("#btn_show_all").hide(100);
                q=query(collection(db, "app"));
            }
            else if(type=="app"){
                $("#btn_show_all").show(100);
                q=query(collection(db, "app"),where("type","==","app"));
            }
            else if(type=="game"){
                $("#btn_show_all").show(100);
                q=query(collection(db, "app"),where("type","==","game"));
            }
            
            var querySnapshot =await getDocs(q);
            querySnapshot.forEach((doc) => {
                var data_app=doc.data();
                var key_name="name_"+lang;
                var htm_item_app="<div class='box_app' id=\""+doc.id+"\">";
                    if(data_app.icon!=null) htm_item_app+="<figure><img class='icon_app item_app' app_id='"+doc.id+"' src=\""+data_app.icon+"\"/></figure>";
                    htm_item_app+="<b class='name_app'>"+read_prop(data_app,key_name)+"</b>";
                    htm_item_app+="<div class='tip_app'>"+data_app.name_en+"</div>";
                    if(list_store!=null){
                        var html_store_link="";
                        $(list_store).each(function(index,store){
                            if(data_app[store.key]!=null){
                                var link_store_app=data_app[store.key];
                                html_store_link+="<a class='link_app' title=\""+store.name+"\" target=\"_blank\" href=\""+link_store_app+"\"><i class=\""+store.icon+"\"></i></a>";
                            }
                        });

                        if(html_store_link!="") htm_item_app+="<div class='list_link_app'>"+html_store_link+"</div>";
                    }

                    htm_item_app+="<div class='btn dev btn_app_edit' app_id='"+doc.id+"'><i class=\"fa-solid fa-pen-to-square\"></i> Edit</div>";
                    htm_item_app+="<div class='btn dev btn_app_del' app_id='"+doc.id+"'><i class=\"fa-solid fa-trash\"></i> Delete</div>";
                    htm_item_app+="<div>";
                $("#all_app").append(htm_item_app);
            });
            check_mode_site();
        }

        function read_prop(obj, prop) {
            return obj[prop];
        }

        async function get_all_field_name_app_lang(){
            if(querySnapshot_lang==null){
                var q = query(collection(db, "lang"));
                querySnapshot_lang =await getDocs(q);
                show_all_field_name_app_lang(querySnapshot_lang);
            }else{
                show_all_field_name_app_lang(querySnapshot_lang);
            }
        }

        $("#btn_list_lang").click(async function(){
            var msg_lang=show_box_msg("Select Lang");
            if(querySnapshot_lang==null){
                var q = query(collection(db, "lang"));
                querySnapshot_lang =await getDocs(q);
                show_menu_lang(querySnapshot_lang);
            }else{
                show_menu_lang(querySnapshot_lang);
            }
        });

        function show_menu_lang(querySnapshot_lang){
            querySnapshot_lang.forEach((doc) => {
                var obj=doc.data();
                var class_active='';
                if(obj.key==lang) class_active="active";
                var htm_item_app="<div class='item_lang item_msg "+class_active+"' key='"+obj.key+"'>";
                htm_item_app+="<img class='item_icon' src='"+obj.icon+"'/><b>"+obj.name+"</b>:"+obj.key;
                htm_item_app+="<div>";
                $("#box_msg_body").append(htm_item_app);
            });
        }

        $('#box_msg_body').on('click', '.item_lang', function() {
            var key_lang=$(this).attr("key");
            if(key_lang!=lang){
                lang=key_lang;
                localStorage.setItem("lang", lang);
                $("#key_lang").html(lang);
                close_box_msg();
                get_all_app();
            }
        });

        $("#all_app").each(function(){
            $(this).each(function(){
               $(this).on('click', '.btn_app_edit',async function() {
                    var id_box_app=$(this).attr("app_id");
                    var q = query(collection(db, "app"), where("name_en", "==", id_box_app));
                    var querySnapshot_edit_app =await getDocs(q);
                    querySnapshot_edit_app.forEach((doc) => {
                        data_edit_app=doc.data();
                        $("#all_app").hide();
                        $("#all-field").html("");
                        $("#box_add_app").show(function(){
                            $.each(data_edit_app, function(key,val) {
                                $("#all-field").append(add_field(key,key,val));
                            });
                            $("#box_app_info").hide();
                            return;
                        });
                    });
                    return;
               });
            });
        });

        $("#all_app").each(function(){
            $(this).each(function(){
               $(this).on('click', '.btn_app_del',async function() {
                    var id_box_app=$(this).attr("app_id");
                    await deleteDoc(doc(db, "app", id_box_app));
                    get_all_app();
                    return;
               });
            });
        });

        $("#all_app").each(function(){
            $(this).each(function(){
               $(this).on('click', '.item_app',async function() {
                    var id_box_app=$(this).attr("app_id");
                    var q = query(collection(db, "app"), where("name_en", "==", id_box_app));
                    var querySnapshot =await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        var app_data=doc.data();
                        $("#all_app").hide();
                        $("#box_app_info").show(function(){show_app_info(app_data,list_store,lang);});
                    });
                    return;
               });
            });
        }); 

        $("#btn_model_site").click(function(){
            if(mode_site=="nomal")
                mode_site="dev";
            else
                mode_site="nomal";
            localStorage.setItem("mode_site",mode_site);
            check_mode_site();
        });

        function check_mode_site(){
            if(mode_site=="nomal")
                $(".dev").each(function(){$(this).hide(100);});
            else
                $(".dev").each(function(){$(this).show(100);});
        }

        function done_add_box(){
            var data_frm=$('#frm_add_app').serializeArray();
            var frm_box=$("#frm_add_app");
            var func=$(frm_box).attr("type");
            var data_obj=objectifyForm(data_frm);

            if(func=="add_app") add_app(data_obj);
            if(func=="add_lang") add_lang(data_obj);
            if(func=="add_link_store") add_link_store(data_obj);

            $('#frm_add_app').each(function(){this.reset();});
            alert("Add Success "+lang+" func:"+func);
        }

        async function add_field_to_box(){
            var func=$("#frm_add_app").attr("type");
            var box_msg=show_box_msg("List Field");

            if(func=="add_app"){
                if(querySnapshot_lang!=null){
                    querySnapshot_lang.forEach((doc) => {
                        var obj=doc.data();
                        if(data_edit_app!=null){
                            if(data_edit_app["name_"+obj.key]!=null)
                                add_field_to_box_msg("name_"+obj.key,"Name("+obj.name+" - "+obj.key+")","","text",null,true);
                            else
                                add_field_to_box_msg("name_"+obj.key,"Name("+obj.name+" - "+obj.key+")");
                        }else{
                            add_field_to_box_msg("name_"+obj.key,"Name("+obj.name+" - "+obj.key+")");
                        }

                    });
                }else{
                    var q = query(collection(db, "lang"));
                    querySnapshot_lang =await getDocs(q);
                    querySnapshot_lang.forEach((doc) => {
                        var obj=doc.data();
                        if(data_edit_app["name_"+obj.key]!=null)
                            add_field_to_box_msg("name_"+obj.key,"Name("+obj.name+" - "+obj.key+")","","text",null,true);
                        else
                            add_field_to_box_msg("name_"+obj.key,"Name("+obj.name+" - "+obj.key+")");
                    });
                }

                if(querySnapshot_link_store!=null){
                    querySnapshot_link_store.forEach((doc) => {
                        var obj=doc.data();
                        if(data_edit_app[obj.key]!=null)
                            add_field_to_box_msg(obj.key,"Link Store ("+obj.name+" - "+obj.key+")","","text",null,true);
                        else
                            add_field_to_box_msg(obj.key,"Link Store ("+obj.name+" - "+obj.key+")");
                    });
                }

                add_field_to_box_msg("type","Type app",0,"select",Array("app","game"));
            }
        }

        $('#box_msg_body').on('click', '.item_field', function() {
            var item_name=$(this).text();
            var item_key=$(this).attr("item_key");
            var item_type=$(this).attr("item_type");
            var item_val=$(this).attr("item_val");
            var item_array_label=$(this).attr("item_array_label");
            $("#all-field").append(add_field(item_key,item_name,item_val,item_type,JSON.parse(item_array_label)));
        });

        function act_mode_dev(){
            count_dev++;
            if(count_dev>=3){
                is_dev=true;
                localStorage.setItem("is_dev",is_dev);
                $("#btn_model_site").show();
                count_dev=0;
                alert("Active Model Dev");
            }
        }

        async function show_list_by_collection(collection_name){
            var q=query(collection(db, collection_name));
            var querySnapshot=await getDocs(q);
            var t="<table>";
            querySnapshot.forEach(doc=>{
                var data_doc=doc.data();
                t+="<tr>";
                $.each(data_doc,function(k,v){
                    t+="<td>"+k+"</td><td>"+v+"</td>";
                });
                t+="</tr>";
            });
            t+="</table>";
            $("#all_app").html(t);
        }

        $("#logo_carrot").on("contextmenu", function(){act_mode_dev();return false;});
        $("#btn_show_add_app").click(function(){show_box_add('add_app',list_store,list_lang)});
        $("#btn_show_add_lang").click(function(){show_box_add('add_lang')});
        $("#btn_show_add_link_store").click(function(){show_box_add('add_link_store')});
        $("#btn_add_field_to_box").click(function(){add_field_to_box();});
        $("#btn_box_msg_close").click(function(){close_box_msg();});
        $("#btn_show_list_lang").click(function(){
            show_list_by_collection("lang");
        });

        $("#btn_done_add_box").click(done_add_box);

        $("#btn_show_app").click(function(){
            get_all_app("app");
        });

        $("#btn_show_game").click(function(){
            get_all_app("game");
        });

        $("#btn_show_all,#btn_all_app,#logo_carrot").click(function(){
            get_all_app();
        });

        function get_param_url(sParam)
        {
            var sPageURL = window.location.search.substring(1);
            var sURLVariables = sPageURL.split('&');
            for (var i = 0; i < sURLVariables.length; i++) 
            {
                var sParameterName = sURLVariables[i].split('=');
                if (sParameterName[0] == sParam) 
                {
                    return sParameterName[1];
                }
            }
        }

        $("#btn_privacy_policy").click(function(){
            $("#all_app").load("privacy_policy/"+lang+".html");
            change_title_page("Privacy Policy","?p=privacy_policy");
        });

        $("#btn_test").click(function(){
            $("#all_app").load("test.html");
        });

        $("#btn_download_json").click(function(){
            download_json();
        });

        $(".btn.btn-menu").click(async function(){
            $(".btn.btn-menu").removeClass("active");
            $(".btn.btn-menu i").removeClass("fa-bounce");
            $(this).addClass("active");
            $(this).find("i").addClass("fa-bounce");
            var id_fun=$(this).attr("id");
            if(id_fun=="btn_all_contact"){
                var q=query(collection(db, "user-"+lang),where("status_share","==","0"));
                var querySnapshot =await getDocs(q);
                show_list_contact(querySnapshot);
            }

            if(id_fun=="btn_all_icon"){
                var q=query(collection(db, "icon"));
                var querySnapshot =await getDocs(q);
                show_list_icon(querySnapshot);
            }

            if(id_fun=="btn_all_background"){
                var q=query(collection(db, "background"));
                var querySnapshot =await getDocs(q);
                show_list_background(querySnapshot);
            }
        });

        $("#btn_import_json").click(function(){
            var url_json = prompt("Enter url json", "Enter url");
            if (url_json != null) {
                $.ajax(url_json,{success:function(data){
                    var name_collection=data.collection;
                    var all_item=data.all_item;
                    var cr_data = collection(db, name_collection);
                    $.each(all_item,function(index,d){
                        var doc_id=d["id_import"];
                        delete d["id_import"];
                        setDoc(doc(cr_data, doc_id), d);
                    });
                    alert("Import Success!");
                }});
            };
        });

        $("#btn_mode_host").click(function(){
            if(is_localhost)
                localStorage.setItem("is_localhost","false");
            else
                localStorage.setItem("is_localhost","true");

            location.reload();
        });

        async function download_json() {
            var name_collection = prompt("Enter collection json", "Enter name collection");
            if(name_collection=="") return;
            var data_json=Object();
            data_json["all_item"]=Array();
            data_json["collection"]=name_collection;
            var q=query(collection(db,name_collection));
            var querySnapshot =await getDocs(q);
            querySnapshot.forEach((doc) => {
                var data_app=doc.data();
                data_app["id_import"]=doc.id;
                data_json.all_item.push(data_app);
            });

            var fileContents=JSON.stringify(data_json, null, 2);
            var fileName= name_collection+".json";

            var pp = document.createElement('a');
            pp.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(fileContents));
            pp.setAttribute('download', fileName);
            pp.click();
        }

        async function get_all_data_field(){
            list_store=Array();
            var q = query(cr_link_store);
            querySnapshot_link_store =await getDocs(q);
            querySnapshot_link_store.forEach((doc) => {
                list_store.push(doc.data());
            });
        };

        async function get_all_data_lang(){
            list_lang=Array();
            var cr_lang= collection(db, "lang");
            var q = query(cr_lang);
            var querySnapshot_lang =await getDocs(q);
            querySnapshot_lang.forEach((doc) => {
                list_lang.push(doc.data());
            });
        };

        $(document).ready(function(){
            var page=get_param_url("p");
            get_all_data_field();
            get_all_data_lang();

            if(page=="privacy_policy"){
                $("#all_app").load("privacy_policy/"+lang+".html");
            }else{
                get_all_app();
            }

            $("#key_lang").html(lang);
            if(is_dev){
                $("#btn_model_site").show();
            }else{
                $("#btn_model_site").hide();
                mode_site=="nomal";
            }

            if(is_localhost){
                $("#btn_mode_host").html('<i class="fa-brands fa-dev"></i> Localhost');
            }else{
                $("#btn_mode_host").html('<i class="fa-sharp fa-solid fa-database"></i> Googlehost');
            }
        });
    </script>
    <script src="js/main.js" type="text/javascript"></script>
</head>
<body>
    <div id="header">
        <img id="logo_carrot" src="images/72.png">

        <div id="btn_all_app" class="btn btn-menu">
            <i class="fa-solid fa-box"></i><br>All Product<br>
            <div>All App</div>
        </div>

        <div id="btn_all_contact" class="btn btn-menu">
            <i class="fa-solid fa-address-book"></i><br>Phone book
        </div>

        <div id="btn_all_background" class="btn btn-menu">
            <i class="fa-solid fa-images"></i><br>Background
        </div>

        <div id="btn_all_icon" class="btn btn-menu">
            <i class="fa-solid fa-face-smile"></i><br>Icon
        </div>

        <a id="btn_itch_store" href="https://carrotstore.itch.io/" target="_blank" class="btn">
            <i class="fa-brands fa-itch-io"></i><br>itch.io
        </a>

        <div id="btn_privacy_policy" class="btn btn-menu">
            <i class="fa-sharp fa-solid fa-building-shield"></i><br>Privacy Policy<br>
        </div>

        <div id="btn_list_lang" class="btn">
            <i class="fa-solid fa-globe"></i><br> Select Lang<br>
            <div id="key_lang">En</div>
        </div>

        <div id="btn_model_site" class="btn">
            <i class="fa-solid fa-window-maximize"></i><br>Development mode
        </div>
    </div>

    <div id="menu_dev" class="dev">
        <div id="btn_show_add_app" class="btn"><i class="fa-solid fa-mobile"></i> Add App</div>
        <div id="btn_show_add_lang"  class="btn"><i class="fa-solid fa-globe"></i> Add Lang</div>
        <div id="btn_show_list_lang"  class="btn"><i class="fa-solid fa-list"></i> List Lang</div>
        <div id="btn_show_add_link_store" class="btn"><i class="fa-solid fa-store"></i> Add Link Store</div>
        <div id="btn_download_json" class="btn"><i class="fa-solid fa-download"></i> Download json</div>
        <div id="btn_import_json" class="btn"><i class="fa-solid fa-file-import"></i> Import json</div>
        <div id="btn_mode_host" class="btn"><i class="fa-brands fa-dev"></i> Localhost</div>
        <div id="btn_test" class="btn"><i class="fa-sharp fa-solid fa-building-shield"></i> Test</div>
    </div>

    <div id="menu_pub" class="pub">
        <div id="btn_show_all" class="btn"><i class="fa-solid fa-certificate"></i> All</div>
        <div id="btn_show_app" class="btn"><i class="fa-solid fa-mobile"></i> App</div>
        <div id="btn_show_game" class="btn"><i class="fa-solid fa-gamepad"></i> Game</div>
    </div>

    <div id="box_add_app" class="box_add">
        <form class="frm" id="frm_add_app" method="post" type="add_app">
            <div class="frm-body">
                <div class="frm-line">
                    <i id="box_add_icon" class="fa-solid fa-mobile"></i> Add App
                </div>
                <div class="frm-all-item" id="all-field"></div>
                <div class="frm-line">
                    <div class="btn" id="btn_done_add_box"><i class="fa-solid fa-circle-check"></i> Done</div>
                    <div class="btn" id="btn_add_field_to_box""><i class="fa-solid fa-circle-plus"></i> Add Field</div>
                    <div class="btn" onclick="close_all_box()"><i class="fa-solid fa-rectangle-xmark"></i> Cancel</div>
                </div>
            </div>
        </form>
    </div>

    <div id="box_app_info"></div>
    <div id="all_app"></div>
    <div id="box_msg">
        <div id="box_msg_border">
            <div id="box_msg_header">
                <div id="box_msg_title">Title</div>
                <div id="btn_box_msg_close" class="btn"><i class="fa-solid fa-rectangle-xmark"></i></div>
            </div>
            <div id="box_msg_body">Body</div>
        </div>
    </div>
    
</body>
</html>